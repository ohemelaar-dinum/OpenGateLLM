import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# Inside Docker

This page describes how to run OpenGateLLM API and playground within docker, along with the required services (postgres, redis...).

## Configuring OpenGateLLM

1. Create a *config.yml* file based on the configuration example file *[config.example.yml](https://github.com/etalab-ia/OpenGateLLM/blob/main/config.example.yml)*. 

  ```bash
  cp config.example.yml config.yml
  ```

2. Create a *env* file based on the environment example file *[env.example](https://github.com/etalab-ia/OpenGateLLM/blob/main/.env.example)*

  ```bash
  cp env.example .env
  ```

3. Create a *compose.yml* file based on the docker compose example file *[compose.example.yml](https://github.com/etalab-ia/OpenGateLLM/blob/main/compose.example.yml)*

  ```bash
  cp compose.example.yml compose.yml
  ```
  Copy paste the docker compose content below:

 ```yml
name: opengatellm

services:
# quickstart services --------------------------------------------------------------------------------------------------------------------------------
  api:
    image: ghcr.io/etalab-ia/opengatellm/app:latest
    restart: always
    env_file: "${APP_ENV_FILE:-./.env}"
    environment:
      - "CONFIG_FILE=config.yml" # inside the container, do not change this line
    ports:
      - 8080:8080
    volumes:
      - "${CONFIG_FILE:-./config.yml}:/config.yml:ro" # outside the container, do not change this line
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy

  playground:
    image: ghcr.io/etalab-ia/opengatellm/ui:latest
    environment:
      - "MASTER_KEY=master_key"
      - "POSTGRES_HOST=${POSTGRES_HOST:-postgres}"
      - "API_HOST=${API_HOST:-api}"
      - "POSTGRES_PORT=${POSTGRES_PORT:-5432}"
      - "POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}"
      - "TZ=Europe/Paris"
    ports:
      - 8081:8501
    volumes:
      - "./${CONFIG_FILE:-config.yml}:/config.yml:ro"
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:16.5
    restart: always
    user: postgres
    environment:
      - "CREATE_DB=api,playground"
      - "POSTGRES_USER=${POSTGRES_USER:-postgres}"
      - "POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}"
      - "POSTGRES_DB=postgres"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres:/var/lib/postgresql/data
      - ./scripts/postgres_entrypoint.sh:/docker-entrypoint-initdb.d/postgres_entrypoint.sh
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-U", "postgres" ]
      interval: 4s
      timeout: 10s
      retries: 5
      start_period: 60s

  redis:
    image: redis/redis-stack-server:7.2.0-v11
    restart: always
    environment:
      REDIS_ARGS: "--dir /data --requirepass ${REDIS_PASSWORD:-changeme} --user ${REDIS_USER:-redis} on >password ~* allcommands --save 60 1 --appendonly yes"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 4s
      timeout: 10s
      retries: 5

volumes:
  postgres:
  redis:


 ```

4. Set hosts variables in .env as localhost as we will be running everything locally for dev purposes

  ```bash
  # example
  POSTGRES_HOST=postgres # instead of POSTGRES_HOST=postgres
  REDIS_HOST=REDIS # instead of POSTGRES_HOST=postgres
  ```
    :::tip
    You can set all HOST variables to their docker container name with:
        <Tabs>
      <TabItem value="Linux" label="Linux" default>
      ```bash
       sed -i 's/^\([A-Z_]*\)_HOST=localhost/\1_HOST=\L\1/' .env
       ```
      </TabItem>
      <TabItem value="MacOs" label="MacOs">
      ```bash
       sed -i '' 's/^\([A-Z_]*\)_HOST=localhost/\1_HOST=\L\1/' .env
       ```
       </TabItem>
    </Tabs>
    :::

5. Export the environment variables:

  ```bash
  export $(grep -v '^#' .env | xargs)
  ```

6. Check the [configuration documentation](getting-started/configuration.md) to configure your configuration file.

## Run OpenGateLLM

Start the OpenGateLLM stack:

```bash
docker compose --env-file .env  up --detach --quiet-pull --wait
```

## Tests

To run the tests:

```bash
docker compose exec -ti api pytest app/tests/unit
```
