import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


# Outside Docker

This page describes how to run OpenGateLLM API and playground locally. The required services (postgres, redis...) run with docker.

## Project python dependencies installation
OpenGateLLM requires:
- Python 3.12+
- Docker and Docker Compose

1. Create a Python [virtual environment](https://docs.python.org/3/library/venv.html). (recommended)

2. Install the dependencies with the following command:

  ```bash
  pip install ".[app,ui,dev,test]"
  ```

## Configuring OpenGateLLM

1. Create a *config.yml* file based on the configuration example file *[config.example.yml](https://github.com/etalab-ia/OpenGateLLM/blob/main/config.example.yml)*. 

  ```bash
  cp config.example.yml config.yml
  ```

2. Create a *env* file based on the environment example file *[env.example](https://github.com/etalab-ia/OpenGateLLM/blob/main/.env.example)*

  ```bash
  cp env.example .env
  ```

3. Create a *compose.yml* file based on the docker compose example file *[compose.example.yml](https://github.com/etalab-ia/OpenGateLLM/blob/main/compose.example.yml)*

  ```bash
  cp compose.example.yml compose.yml
  ```
  Copy paste the docker compose content below:

 ```yml
name: opengatellm

services:
  postgres:
    image: postgres:16.5
    restart: always
    user: postgres
    environment:
      - "CREATE_DB=api,playground"
      - "POSTGRES_USER=${POSTGRES_USER:-postgres}"
      - "POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}"
      - "POSTGRES_DB=postgres"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres:/var/lib/postgresql/data
      - ./scripts/postgres_entrypoint.sh:/docker-entrypoint-initdb.d/postgres_entrypoint.sh
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready", "-U", "postgres" ]
      interval: 4s
      timeout: 10s
      retries: 5
      start_period: 60s

  redis:
    image: redis/redis-stack-server:7.2.0-v11
    restart: always
    environment:
      REDIS_ARGS: "--dir /data --requirepass ${REDIS_PASSWORD:-changeme} --user ${REDIS_USER:-redis} on >password ~* allcommands --save 60 1 --appendonly yes"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 4s
      timeout: 10s
      retries: 5

volumes:
  postgres:
  redis:

 ```

4. Set hosts variables in .env as localhost as we will be running everything locally for dev purposes

  ```bash
  # example
  POSTGRES_HOST=localhost # instead of POSTGRES_HOST=postgres
  ```
    :::tip
    You can set all HOST variables to localhost with:
        <Tabs>
      <TabItem value="Linux" label="Linux" default>
      ```bash
       sed -i 's/^\([A-Z_]*_HOST\)=.*/\1=localhost/' .env
       ```
      </TabItem>
      <TabItem value="MacOs" label="MacOs">
      ```bash
       sed -i '' 's/^\([A-Z_]*_HOST\)=.*/\1=localhost/' .env
       ```
       </TabItem>
    </Tabs>
    :::

5. Export the environment variables:

  ```bash
  export $(grep -v '^#' .env | xargs)
  ```

6. Check the [configuration documentation](getting-started/configuration.md) to configure your configuration file.

### Run services

Start services locally with the following command:

```bash
make dev
```


## Tests

To run the tests:

```bash
make test
```

## Modifications to SQL database structure

If you have modified the API database tables in the [models.py](https://github.com/etalab-ia/OpenGateLLM/blob/main/api/sql/models.py) file, you need to create an Alembic migration with the following command:

```bash
alembic -c app/alembic.ini revision --autogenerate -m "message"
```

Then apply the migration with the following command:

```bash
alembic -c app/alembic.ini upgrade head
```

